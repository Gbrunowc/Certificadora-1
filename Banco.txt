
-- Necessita do banco de dados BFdb (como declarado abaixo) e conectado a Porta 5432
-- CREATE DATABASE "BFdb" WITH OWNER = POSTGRES ENCODING = 'UTF8' LC_COLLATE = 'Portuguese_Brazil.1252' LC_CTYPE = 'Portuguese_Brazil.1252' LOCALE_PROVIDER = 'libc' TABLESPACE = PG_DEFAULT CONNECTION LIMIT = -1 IS_TEMPLATE = FALSE;


-- Criação de Usuario e Tabelas, e exemplos de cadastros no final


CREATE ROLE "BFadmin" WITH
  LOGIN
  SUPERUSER
  INHERIT
  CREATEDB
  CREATEROLE
  NOREPLICATION
  BYPASSRLS
  ENCRYPTED PASSWORD 'SCRAM-SHA-256$4096:hVVZPGZ19tS/ii07XsmdNg==$OzRotseUvb93lZfncSN7i9l6mmuh+NltTHy45/g88Ao=:WlitvapJMM/1pUSyGxPzdo5zGg/GQQw27ql5Pu8F/sg=';



CREATE TABLE VOLUNTARIO (
	VOL_NOME VARCHAR(30) NOT NULL,
	VOL_CPF BIGINT,
	VOL_DATA DATE NOT NULL,
	PRIMARY KEY (VOL_CPF),
	UNIQUE (VOL_CPF)
);

CREATE TABLE LOG_VOLUNTARIO (
	LOG_ID SERIAL PRIMARY KEY,
	VOL_CPF BIGINT NOT NULL,
	VOL_NOME_ORIGINAL VARCHAR(30),
	VOL_NOME_ALTERADO VARCHAR(30),
	VOL_DATA_ORIGINAL DATE,
	VOL_DATA_ALTERADO DATE,
	DATA_ALTERACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	USUARIO VARCHAR(50) DEFAULT CURRENT_USER
);

CREATE
OR REPLACE FUNCTION LOG_VOLUNTARIO () RETURNS TRIGGER AS $$
BEGIN
    IF OLD.vol_nome <> NEW.vol_nome OR OLD.vol_data <> NEW.vol_data THEN
        INSERT INTO log_voluntario (vol_cpf, vol_nome_original, vol_nome_alterado, vol_data_original, vol_data_alterado)
        VALUES (OLD.vol_cpf, OLD.vol_nome, NEW.vol_nome, OLD.vol_data, NEW.vol_data);
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE PLPGSQL;

CREATE TRIGGER TRIGGER_LOG_VOLUNTARIO
AFTER
UPDATE ON VOLUNTARIO FOR EACH ROW
EXECUTE FUNCTION LOG_VOLUNTARIO ();

CREATE TABLE DISPONIBILIDADE (
	ID SERIAL PRIMARY KEY,
	VOL_CPF BIGINT,
	DIS_DIA INT,
	DIS_INICIO TIME,
	DIS_FIM TIME,
	FOREIGN KEY (VOL_CPF) REFERENCES VOLUNTARIO (VOL_CPF)
);

-- Inserts para exemplo abaixo, criados com auxilio de Inteligencia artificial (ChatGPT)
INSERT INTO
	VOLUNTARIO (VOL_NOME, VOL_CPF, VOL_DATA)
VALUES
	('Ana Souza', 12345678901, '1990-05-15'),
	('Carlos Mendes', 23456789012, '1985-10-20'),
	('Mariana Lima', 34567890123, '1992-03-08'),
	('João Pedro', 45678901234, '1988-07-22'),
	('Fernanda Rocha', 56789012345, '1995-12-30'),
	('Roberto Silva', 67890123456, '1980-09-14'),
	('Beatriz Campos', 78901234567, '1993-06-25'),
	('Ricardo Almeida', 89012345678, '1987-04-10'),
	('Vanessa Torres', 90123456789, '1991-08-05'),
	('Gustavo Nunes', 11223344556, '1996-02-18');

INSERT INTO
	DISPONIBILIDADE (VOL_CPF, DIS_DIA, DIS_INICIO, DIS_FIM)
VALUES
	(12345678901, 1, '08:00', '12:00'),
	(12345678901, 3, '14:00', '18:00'),
	(12345678901, 5, '09:00', '13:00'),
	(23456789012, 2, '09:00', '13:00'),
	(23456789012, 4, '10:00', '14:00'),
	(23456789012, 6, '14:00', '18:00'),
	(34567890123, 1, '07:00', '11:00'),
	(34567890123, 3, '16:00', '20:00'),
	(34567890123, 5, '08:00', '12:00'),
	(45678901234, 2, '13:00', '17:00'),
	(45678901234, 4, '09:00', '12:00'),
	(45678901234, 6, '10:00', '14:00'),
	(56789012345, 1, '14:00', '18:00'),
	(56789012345, 3, '08:00', '12:00'),
	(56789012345, 5, '16:00', '20:00'),
	(67890123456, 2, '07:00', '11:00'),
	(67890123456, 4, '15:00', '19:00'),
	(67890123456, 6, '09:00', '13:00'),
	(78901234567, 3, '10:00', '14:00'),
	(78901234567, 5, '07:00', '11:00'),
	(78901234567, 7, '15:00', '19:00'),
	(89012345678, 1, '13:00', '17:00'),
	(89012345678, 3, '09:00', '12:00'),
	(89012345678, 5, '10:00', '14:00'),
	(90123456789, 2, '08:00', '12:00'),
	(90123456789, 4, '14:00', '18:00'),
	(90123456789, 6, '07:00', '11:00'),
	(11223344556, 3, '16:00', '20:00'),
	(11223344556, 5, '09:00', '13:00'),
	(11223344556, 7, '14:00', '18:00');